# ЛР6 — Работа с файлами (эмуляция S3‑хранилища)

**Автор:** Бизюк Андрей

**Дата выполнения:** 19 января 2026

## Тема
Реализация загрузки, хранения и управления файлами с использованием локального хранилища в качестве эмуляции S3.

## Цель
Научиться работать с файловой системой Laravel, имитируя облачное хранилище, и реализовать CRUD для мультимедийных данных.

## Краткое описание выполненной работы
- Добавлен фейковый диск `s3-fake` в `config/filesystems.php` (root: `storage/app/s3-fake`, публичный URL — `APP_URL/s3-fake`).
- Значение `FILESYSTEM_DISK` установлено в `.env` в `s3-fake` для локальной разработки.
- Создана модель `Media` и миграция для таблицы `media` (поле `path`, `post_id`, `type`, `timestamps`).
- В `Post` добавлена связь `media()` (`hasMany`).
- В `PostController` реализована поддержка загрузки нескольких файлов (`files[]`) в `store` и `update`, создание записей `Media`, удаление файлов и запись в БД (`destroyFile` + поддержка удаления через форму редактирования `delete_files[]`).
- Добавлено поле загрузки в общий partial формы `resources/views/posts/_form.blade.php` и отображение галереи в `resources/views/posts/show.blade.php` с возможностью открыть или удалить файл.
- Добавлен кастомный валидатор `no_spaces` (запрет пробелов в имени файла) и middleware `LogFileOperations` для логирования имён загруженных файлов.
- Добавлена оптимизация изображений через пакет `spatie/image-optimizer` — оптимизация выполняется перед сохранением (в `PostController`), ошибки оптимизации логируются и не мешают сохранению.
- Создан симлинк `public/s3-fake` → `storage/app/s3-fake` для отдачи файлов по URL `http://host/s3-fake/...`.

## Чеклист (требования лабораторной)
- [x] Настроить фейковый S3-диск (`s3-fake`).
- [x] Реализовать загрузку файлов к постам (массив `files[]`).
- [x] Добавить валидацию файлов (mimes, max, запрет пробелов `no_spaces`).
- [x] Организовать просмотр (галерея + ссылки) и удаление файлов (через отдельный маршрут и через форму редактирования).
- [x] Логирование операций загрузки (`LogFileOperations`).
- [x] Оптимизация изображений перед сохранением (spatie/image-optimizer).  

## Основные файлы реализации
- `config/filesystems.php` — диск `s3-fake`.
- `.env` — `FILESYSTEM_DISK=s3-fake`.
- `app/Models/Media.php` — модель Media.
- `database/migrations/2026_01_19_120000_create_media_table.php` — миграция.
- `app/Models/Post.php` — добавлен `media()`.
- `app/Http/Controllers/PostController.php` — логика загрузки/удаления/оптимизации файлов.
- `app/Http/Middleware/LogFileOperations.php` — middleware логирования загрузок.
- `app/Providers/AppServiceProvider.php` — регистрация валидатора `no_spaces`.
- `resources/views/posts/_form.blade.php` — поле `files[]` + список существующих файлов с чекбоксами удаления.
- `resources/views/posts/show.blade.php` — галерея и кнопки удаления/открытия.
- `routes/web.php` — маршруты `posts.store` (с middleware логирования), `posts.viewFile` (редирект на публичный URL) и `posts.deleteFile`.

## Команды для проверки (локально)
1. Создать папку и симлинк (если нужно):

```bash
cd /workspaces/labs/my-personal-blog
mkdir -p storage/app/s3-fake
php artisan storage:link   # уже создан для public/storage
ln -s ../storage/app/s3-fake public/s3-fake   # если нужно вручную
```

2. Миграции и проверка таблицы `media`:

```bash
php artisan migrate --force
sqlite3 database/database.sqlite "SELECT name FROM sqlite_master WHERE type='table' AND name='media';"
```

3. Тесты функционала (через браузер):
- Откройте `http://127.0.0.1:8000/posts/create` — загрузите несколько файлов (изображения, PDF, MP4). Проверьте, что они появились в `storage/app/s3-fake/posts/{post_id}`.
- Откройте страницу поста — изображения отображаются, файлы доступны по ссылке `http://127.0.0.1:8000/s3-fake/posts/{post_id}/{file}`.
- В форме редактирования отметьте файлы для удаления и сохраните — файлы удалились из `storage/app/s3-fake` и из таблицы `media`.

## Примечания и рекомендации
- spatie/image-optimizer использует внешние бинарники (jpegoptim, optipng, pngquant, gifsicle, svgo). Если их нет в окружении, оптимизация молча не выполнится — при необходимости установите их в контейнер/хост.
- В продакшене замените `s3-fake` на реальный `s3` диск и настройте переменные AWS в `.env`.
- Для тестирования используйте `Storage::fake('s3-fake')` в unit/feature тестах.

## Вывод
Реализованы все пункты лабораторной работы 6: настройка эмуляции S3, загрузка/просмотр/удаление файлов, валидация, логирование и базовая оптимизация изображений. Готов предоставить помощь с добавлением нативных оптимизаторов или написанием feature‑тестов.
